version: 2.1
orbs:
  revenuecat: revenuecat/sdks-common-config@3.0.0

aliases:
  release-tags: &release-tags
    filters:
      tags:
        ignore: /^.*-SNAPSHOT/
      branches:
        ignore: /.*/
  release-branches: &release-branches
    filters:
      tags:
        ignore: /.*/
      branches:
        only: /^release\/.*/

parameters:
  action:
    type: enum
    enum: [default, bump]
    default: default
  version:
    type: string
    default: ""

commands:
  install-dependencies:
    steps:
      - restore_cache:
          keys:
            - yarn-v2-{{ checksum "yarn.lock" }}
      - run:
          name: Yarn Install
          command: yarn
      - save_cache:
          key: yarn-v2-{{ checksum "yarn.lock" }}
          paths:
            - .yarn/cache

jobs:
  docs-deploy:
    docker:
      - image: cimg/ruby:3.3.0-node
    steps:
      - checkout
      - install-dependencies
      - revenuecat/install-gem-unix-dependencies:
          cache-version: v1
      - revenuecat/setup-git-credentials
      - run:
          name: Build docs
          command: bundle exec fastlane generate_docs

  make-release:
    description: "Publishes the new version and creates a github release"
    docker:
      - image: cimg/ruby:3.3.0-node
    steps:
      - checkout
      - install-dependencies
      - revenuecat/install-gem-unix-dependencies:
          cache-version: v1
      - revenuecat/trust-github-key
      - run:
          name: release
          command: bundle exec fastlane release

  test:
    docker:
      - image: cimg/ruby:3.3.0-browsers
    steps:
      - checkout
      - install-dependencies
      - revenuecat/install-gem-unix-dependencies:
          cache-version: v1
      - revenuecat/setup-git-credentials
      - run:
          name: Install node dependencies
          command: npm ci
      - run:
          name: Install dependencies rcbilling-demo
          working_directory: examples/rcbilling-demo
          command: npm ci
      - run:
          name: Linting
          command: npm run lint
      - run:
          name: Linting rcbilling-demo
          working_directory: examples/rcbilling-demo
          command: npm run lint
      - run:
          name: Prettier
          command: npm run prettier:ci
      - run:
          name: Prettier rcbilling-demo
          working_directory: examples/rcbilling-demo
          command: npm run prettier:ci
      - run:
          name: Type checker including tests
          command: npm run test:typeCheck
      - run:
          name: Svelte check
          command: npm run svelte-check
      - run:
          name: Unit tests
          command: npm run test
      - run:
          name: Build
          command: npm run build
      - run:
          name: Extract API using api-extractor
          command: npm run extract-api
      - run:
          name: Check if API has changed
          command: git diff --exit-code api-report/**
      - run:
          name: Pack
          command: npm pack
      - run:
          name: Build rcbilling-demo
          working_directory: examples/rcbilling-demo
          command: npm run build
      - run:
          name: E2E tests rcbilling-demo
          working_directory: examples/rcbilling-demo
          command: npm run test:ci

workflows:
  danger:
    when:
      not:
        equal: [scheduled_pipeline, << pipeline.trigger_source >>]
    jobs:
      - revenuecat/danger

  weekly-run-workflow:
    when:
      and:
        - equal: [scheduled_pipeline, << pipeline.trigger_source >>]
        - equal: ["release-train", << pipeline.schedule.name >>]
    jobs:
      - revenuecat/automatic-bump

  manual-trigger-bump:
    when:
      equal: [bump, << pipeline.parameters.action >>]
    jobs:
      - revenuecat/automatic-bump

  test-deploy:
    when:
      not:
        equal: [ scheduled_pipeline, << pipeline.trigger_source >> ]
    jobs:
      - test
      - hold:
          requires:
            - test
          type: approval
          <<: *release-branches
      - revenuecat/tag-current-branch:
          requires:
            - hold
          <<: *release-branches
      - make-release:
          <<: *release-tags
      - docs-deploy:
          <<: *release-tags
          requires:
            - make-release
