trigger:
  branches:
    include:
      - main
  tags:
    include:
      - v*
  paths:
    exclude:
      - "*"

pr:
  - "*"

pool:
  vmImage: "ubuntu-latest"

variables:
  npm_config_cache: $(Pipeline.Workspace)/.npm

jobs:
  - job: RunTests
    displayName: "Run Tests"
    steps:
      - task: NodeTool@0
        inputs:
          versionSpec: "18.x"
        displayName: "Install Node.js"

      - task: Cache@2
        inputs:
          key: 'npm | "$(Agent.OS)" | package-lock.json'
          restoreKeys: 'npm | "$(Agent.OS)"'
          path: $(npm_config_cache)
        displayName: "Cache npm"

      - script: npm ci
        displayName: "Install dependencies"

      - script: npm run lint
        displayName: Linting

      - script: npm run prettier:ci
        displayName: Prettier

      - script: npm run test
        displayName: Unit tests

      - script: npm run build
        displayName: "Build"

      - script: npm pack
        displayName: "Pack"

      - bash: |
          if [[ "$(Build.SourceBranch)" == refs/tags/v* ]]; then
            echo "Publishing to npm..."
            npm publish --access private
          else
            echo "Not a tag push, will not publish to npm."
          fi
        displayName: "Publish to npm"
        env:
          NODE_AUTH_TOKEN: $(NpmAuthToken)